"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var vfile=_interopDefault(require("to-vfile")),unified=_interopDefault(require("unified")),remark=_interopDefault(require("remark-parse")),matter=_interopDefault(require("remark-frontmatter")),slug=_interopDefault(require("remark-slug")),parseFrontmatter=_interopDefault(require("remark-parse-yaml")),find=_interopDefault(require("unist-util-find")),is=_interopDefault(require("unist-util-is")),visit=_interopDefault(require("unist-util-visit")),humanize=_interopDefault(require("humanize-string")),flatten=_interopDefault(require("lodash.flatten")),jsxUtils=require("jsx-ast-utils"),strip=_interopDefault(require("strip-indent")),escapeJS=_interopDefault(require("js-string-escape")),parser=require("@babel/parser"),generator=require("@babel/generator"),generator__default=_interopDefault(generator),traverse=_interopDefault(require("@babel/traverse")),get=_interopDefault(require("lodash.get")),codesandboxerFs=require("codesandboxer-fs"),unescapeJS=_interopDefault(require("unescape-js")),prettier=require("prettier"),logger=_interopDefault(require("signale")),path=require("path");const valueFromTraverse=(e,r=(e=>e))=>t=>{let a="";const s=parser.parse(t,{plugins:["jsx"]});return traverse(s,{enter(t){if(e(t))return a=r(t),void t.stop()}}),a},codeFromNode=e=>r=>valueFromTraverse(e,e=>r.slice(e.node.start,e.node.end))(r);var ast=Object.freeze({valueFromTraverse:valueFromTraverse,codeFromNode:codeFromNode});const parseMdx=e=>{const r=vfile.readSync(e,"utf-8"),t=unified().use(remark,{type:"yaml",marker:"-"}).use(matter).use(parseFrontmatter).use(slug);return t.run(t.parse(r))},getChildValue=e=>e.map(e=>e.children?getChildValue(e.children):e.value),valueFromHeading=e=>{const r=get(e,"children"),t=get(e,"data.id");return Array.isArray(r)?flatten(getChildValue(r)).filter(Boolean).join(" "):humanize(t)},headingsFromAst=e=>{const r=[];return visit(e,"heading",e=>{const t=get(e,"data.id"),a=get(e,"depth");r.push({depth:a,slug:t,value:valueFromHeading(e)})}),r},getParsedData=e=>{const r=find(e,e=>is("yaml",e));return get(r,"data.parsedValue")||{}};var mdast=Object.freeze({parseMdx:parseMdx,headingsFromAst:headingsFromAst,getParsedData:getParsedData});const propFromElement=e=>valueFromTraverse(e=>e.isJSXOpeningElement(),r=>jsxUtils.getPropValue(jsxUtils.getProp(r.node.attributes,e))),removeTags=e=>{const r=codeFromNode(e=>e.isJSXOpeningElement()),t=codeFromNode(e=>e.isJSXClosingElement());return e.replace(r(e),"").replace(t(e),"")},sanitizeCode=e=>{const r=strip(e).trim(),t=r.startsWith("{")&&r.endsWith("}")?r.substr(1,r.length-2):r;return escapeJS(strip(t))},componentName=e=>{const r=e.match(/^\<\\?(\w+)/);return r&&r[1]};var jsx=Object.freeze({propFromElement:propFromElement,removeTags:removeTags,sanitizeCode:sanitizeCode,componentName:componentName});const fromSpecifiers=(e=[])=>Array.isArray(e)&&e.length>0?e.map(e=>get(e,"local.name")):[],traverseOnImports=e=>r=>{try{const t=parser.parse(r.value,{sourceType:"module"});let a=[];return traverse(t,{enter(r){r.isImportDeclaration()&&"docz"!==get(r,"node.source.value")&&(a=a.concat(e(r)))}}),a}catch(e){return[]}},getFullImports=traverseOnImports(e=>[get(generator__default(e.node),"code")]),getImportsVariables=traverseOnImports(e=>fromSpecifiers(e.node.specifiers));var imports=Object.freeze({getFullImports:getFullImports,getImportsVariables:getImportsVariables});const formatter=e=>prettier.format(e,{parser:"babylon",semi:!1,singleQuote:!0,trailingComma:"all"}),format=e=>new Promise((r,t)=>{try{r(formatter(e))}catch(e){logger.fatal(e),r(e)}}),classComponent=e=>{const r=e.match(/(class)(\s)(\w+)/m);return`\n    {() => {\n      ${e}\n      return <${r&&r[3]} />\n    }}\n  `},checkCodeToRender=e=>e.startsWith("()")?`{${e}}`:e.startsWith("class")?classComponent(e):`<React.Fragment>${e}</React.Fragment>`,wrapCode=e=>`import React from 'react';\n  import { jsx } from '@emotion/core'\n\n  const doczStyles = {\n    margin: '0 3px',\n    padding: '4px 6px',\n    fontFamily: '"Source Code Pro", monospace',\n    fontSize: 14,\n  };\n\n  const App = ({ children }) => (\n    <div style={doczStyles}>\n      {children && typeof children === 'function' ? children() : children}\n    </div>\n  )\n\n  export default () => (\n    <App>\n      ${checkCodeToRender(unescapeJS(e))}\n    </App>\n  )`;function getSandboxFiles(e,r,t){const a=[...r,formatter(wrapCode(e))].join("\n"),s=path.join(t,"codesandbox.example.csb.js");return codesandboxerFs.assembleFiles(s,{contents:a,extensions:[".js",".jsx",".ts",".tsx",".md",".html",".htm",".css",".css.less",".css.sass",".less",".sass",".scss",".svg",".png",".jpg",".jpeg"]})}const getSandboxImportInfo=async(e,r,t)=>{let a;try{const{parameters:s}=await getSandboxFiles(e,r,t);a=s}catch(e){console.error("Could not create Open in CodeSandbox",e)}return a};var codesandbox=Object.freeze({getSandboxImportInfo:getSandboxImportInfo});function namedAssetImport({types:e}){const r=new WeakSet;return{visitor:{ImportDeclaration(t,{opts:{loaderMap:a}}){const s=t.node.source.value,n=path.extname(s).substr(1);r.has(t.node)||-1!==s.indexOf("!")||a[n]&&t.replaceWithMultiple(t.node.specifiers.map(t=>{if(e.isImportDefaultSpecifier(t)){const a=e.importDeclaration([e.importDefaultSpecifier(e.identifier(t.local.name))],e.stringLiteral(s));return r.add(a),a}const o=e.importDeclaration([e.importSpecifier(e.identifier(t.local.name),e.identifier(t.imported.name))],e.stringLiteral(a[n][t.imported.name]?a[n][t.imported.name].replace(/\[path\]/,s):s));return r.add(o),o}))}}}}exports.ast=ast,exports.mdast=mdast,exports.format=format,exports.imports=imports,exports.jsx=jsx,exports.codesandbox=codesandbox,exports.namedAssetImport=namedAssetImport;
